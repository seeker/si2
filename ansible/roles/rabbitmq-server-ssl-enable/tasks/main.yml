---
- name: Erlang SSL lib must exist
  stat:
    path: "{{ erlang_ssl_path }}"
  register: erlang_ssl_path_stat

- name: Fail if the Erlang SSL library is not found
  fail:
    msg: "Erlang SSL path not found"
  when: not(erlang_ssl_path_stat.stat.isdir is defined and erlang_ssl_path_stat.stat.isdir)

- name: Create RabbitMQ SSL configuration
  template:
    src: ssl_dist.config.j2
    dest: "{{ rabbitmq_ssl_config }}"
    owner: rabbitmq
    group: rabbitmq

- name: Enable SSL in RabbitMQ enviroment configuration
  template:
    src: rabbitmq-env.conf.j2
    dest: "{{ rabbitmq_config_dir }}/rabbitmq-env.conf"
    owner: rabbitmq
    group: rabbitmq

- name: Register RabbitMQ SSL service with consul
  consul:
    service_name: rabbitmq-ssl
    service_port: 5671
    tags: message-broker,rabbitmq
    
- name: Copy CA certificate
  copy:
    src: "{{ ca_cert_source }}"
    dest: "{{ rabbitmq_config_dir }}/ca_cert.pem"
    owner: rabbitmq
    group: rabbitmq
    mode: "u=rwx,g=rwx,o="
    remote_src: "{{ remote_source }}"

- name: Copy server certificate
  copy:
    src: "{{ server_cert_source }}"
    dest: "{{ rabbitmq_config_dir }}/server_cert.pem"
    owner: rabbitmq
    group: rabbitmq
    mode: "u=rwx,g=rwx,o="
    remote_src: "{{ remote_source }}"

- name: Copy server key
  copy:
    src: "{{ server_key_source }}"
    dest: "{{ rabbitmq_config_dir }}/server_key.pem"
    owner: rabbitmq
    group: rabbitmq
    mode: "u=rwx,g=rwx,o="
    remote_src: "{{ remote_source }}"

- name: Copy client certificate
  copy:
    src: "{{ client_cert_source }}"
    dest: "{{ rabbitmq_config_dir }}/client_cert.pem"
    owner: rabbitmq
    group: rabbitmq
    mode: "u=rwx,g=rwx,o="
    remote_src: "{{ remote_source }}"

- name: Copy client key
  copy:
    src: "{{ client_key_source }}"
    dest: "{{ rabbitmq_config_dir }}/client_key.pem"
    owner: rabbitmq
    group: rabbitmq
    mode: "u=rwx,g=rwx,o="
    remote_src: "{{ remote_source }}"

# TODO conditional restart, only if config files or certs have changed
- name: Restart RabbitMQ server
  systemd:
    name: rabbitmq-server
    state: restarted
