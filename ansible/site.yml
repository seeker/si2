---
- hosts: vagrant
  become_user: root
  become: yes

  roles:
    - consul-binary

- hosts: consul_server
  become_user: root
  become: yes

  roles:
  - consul-service
  - consul-kv-config
  vars:
    - server: yes
    - consul_client_ip: "{{ bind_ip }}"

- hosts: vault
  become_user: root
  become: yes
    
  roles:
  - vault-binary
  - consul-service
  - vault-service
  - dev-vault-init
  - vault-approle-auth
  - vault-policy
  - vault-pki
  - vault-kv
  handlers:
    - import_tasks: handlers/main.yml

- hosts: mongodb
  become_user: root
  become: yes
  roles:
  - consul-service
  - mongodb-server

- hosts: rabbitmq
  become_user: root
  become: yes
  roles:
  - consul-service
  - rabbitmq-server
  - rabbitmq-server-node-tls
  - dev-rabbitmq-credentials

- hosts: vault
  become_user: root
  become: yes

  roles:
  - vault-rabbitmq-secrets
  - dev-vault-credentials

- hosts: nomad
  become_user: root
  become: yes

  roles:
    - nomad-binary
    - consul-binary
    - consul-service
    - nomad-service
  handlers:
    - import_tasks: handlers/main.yml
  
  vars:
    - nomad_server: true
    - nomad_client: true
    - server: yes
    - bind_ip: "10.0.2.15"
    - consul_server: "{{ bind_ip }}"
